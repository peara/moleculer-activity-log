stages:
  - test
  - deploy

test-ci:
  stage: test
  tags:
    - runner-docker
  image: node:10.16
  cache:
    paths:
      - node_modules/
  services:
    - postgres:11.3
    - redis:5
  variables:
    CACHER: redis://redis:6379
    POSTGRES_DB: activity_log_test
    POSTGRES_USER: activity_log_ci
    POSTGRES_PASSWORD: activity_log_ci
  script:
    - npm install
    - npx knex migrate:latest --env ci
    - npm run lint
    - npm run test-ci

deploy-staging:
  stage: deploy
  tags:
    - runner-deploy
  variables:
    IMAGE_NAME: activity-log-service
    GIT_STRATEGY: clone
  script:
    - docker build -t $IMAGE_NAME .
    - cat "$GCLOUD_SERVICE_KEY" | docker login -u _json_key --password-stdin https://asia.gcr.io
    - docker tag $IMAGE_NAME asia.gcr.io/$GCP_PROJECT_ID/$IMAGE_NAME:latest
    - docker push asia.gcr.io/$GCP_PROJECT_ID/$IMAGE_NAME:latest
    - /home/gitlab-runner/staging-scripts/deploy.sh
  only:
    - dev
